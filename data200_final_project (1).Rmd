---
title: "foundations project"
output: html_document
date: "2023-10-25"
---

# Set up

```{r}
library(tidyverse)
library(sf)
library(terra)
library(tidycensus)
library(tigris)
library(censusxy)
library(tmap)
library(flexmix)
library(ggplot2)
library(geosphere)
```

# Bring in data

```{r}
women <- read_csv("women.csv") %>%
  janitor::clean_names() %>% # clean column names so easier to work with %>%
  filter(!duplicated(business_name, physical_location_address)) %>% # filter out fully duplicated rows with exact same entries
  mutate(state = "Massachusetts", # add column for state for geocoding 
         street_address = str_to_title(street_address), #clean names 
         other_information = case_when(other_information == "Minority-owned, N/A" ~ "Minority-owned",
                                       other_information == "Immigrant-owned, N/A" ~ "Immigrant-owned",
                                       .default = other_information)) # this is to standardize and combine forms

  
  
income <- tidycensus::get_acs(geography = "tract", 
                              state = "Massachusetts", 
                              table = "S1901",
                              year = 2021,
                              survey = "acs5")

tract_geo <- tracts(state = "Massachusetts",
                    year = 2021)

label_acs <- tidycensus::load_variables(year = 2021,
                                    dataset = "acs5/subject") %>%
  rename(variable = name)
```

# Combine income and geography

```{r}
income_geo <- full_join(income, tract_geo, by = "GEOID") %>%
  left_join(label_acs) %>%
  st_as_sf()
```

# Geocode

```{r}
women_geocoded <-
  cxy_geocode(.data = women,
              street = "street_address",
              city = "city",
              state = "state",
              zip = "business_zipcode")
```

This gives us `r sum(is.na(women_geocoded$cxy_lat))` lat/lon coordinates. We are only missing `r sum(is.na(women_geocoded$"Street address"))` street addresses.

Upon visual inspection, issues come from "Commercial Wharf" and "Faneuil Hall", so we need to give those actual addresses from Google. Other issues include missing addresses, which we can manually enter here:

# Add in addresses

```{r}
women$street_address[women$street_address == "Faneuil Hall Marketplace"] <- "4 South Market"
women$street_address[women$street_address == "Commercial Wharf"] <- "47 Commercial Wharf"
```

# Geocode again

```{r}
women_geocoded <-
  cxy_geocode(.data = women,
              street = "street_address",
              city = "city",
              state = "state",
              zip = "business_zipcode")
```

# Add in geocodes of missing ones from Google

```{r}
women_geocoded$cxy_lat[women_geocoded$street_address == "6 Liberty Square"] <- 42.35804
women_geocoded$cxy_lon[women_geocoded$street_address == "6 Liberty Square"] <- -71.05523

women_geocoded$cxy_lat[women_geocoded$street_address == "25 Dorchester Ave"] <- 42.34926
women_geocoded$cxy_lon[women_geocoded$street_address == "25 Dorchester Ave"] <- -71.05516

women_geocoded$cxy_lat[women_geocoded$street_address == "51 B St"] <- 42.10534
women_geocoded$cxy_lon[women_geocoded$street_address == "51 B St"] <- -70.87581
```

Now we have `r sum(is.na(women_geocoded$cxy_lat))` values without geocode. After checking them all over, many are virtual businesses and therefore do not have store fronts. Many businesses also appear to be out of date as their website does not show up.

There was only one business (F2 Fitness Wellness), that we could not find an address for but appeared to be up and running and in person. Their website lists DC as the address, but the street address they gave does not line up with the zip code they provided. So we exclude `r sum(is.na(women_geocoded$cxy_lat))` businesses total, but `r sum(is.na(women_geocoded$cxy_lat)) - 1` due to lack of physical presence.

# Join women dataframe with income based on geography

```{r}
# filter out null location values
women_geocoded <- women_geocoded %>%
  filter(!is.na(cxy_lat)) # filter columns with missing geography

  #convert women_geocoded to sf object
women_geocoded_sf <- women_geocoded %>%
  st_as_sf(coords = (108:109), crs = crs(income_geo)) 

# combine with income data
women_income <- st_join(women_geocoded_sf, income_geo) %>%
  select(!c(moe, variable)) %>% # remove margin of error column 
  pivot_wider(names_from = "label",
              values_from = "estimate") %>%
  janitor::clean_names()

```

# Categorize business types into 9 different groups for modeling
```{r}
women_income <- women_income %>%
  mutate(professional_services = ifelse(business_type == "Professional Services" | business_type == "Real Estate Broker/Owner" | business_type == "Website Design" |business_type == "Professional Services, Coach women entrepreneurs start a business"|business_type == "Creative Economy, Professional Services, Advertising, Marketing, Branding"|business_type == "Development and Construction"|business_type == "Financial Services, Healthcare, Professional Services"|business_type == "Financial Services, Healthcare, Professional Services, Consulting" |business_type == "Construction"|business_type == "Financial Services" |business_type == "Creative Economy, Professional Services, Retail, Creative Agency"|business_type == "Professional Services, Residential and Commercial Real Estate Sales and Leasing"|business_type == "Retail, Interior Design & Construction Project Management"|business_type == "Communications and Public Affairs" |business_type == "Education, Financial Services"|business_type == "Professional Services, Executive Search/Recruiting/Human Resources Consulting"|business_type == "Clean-tech/Green-tech, Education, Healthcare, Professional Services, Cleaning industry"|business_type == "Creative Economy, Professional Services"|business_type == "Real Estate"|business_type == "Life Coaching"|business_type == "Architecture"|business_type == "Coaching"|business_type ==  "Professional Services, software testing and data analysis - we can work with any business, any industry"|business_type == "Technology"|business_type == "Professional Services, Real Estate Brokerage"|business_type == "Clean-tech/Green-tech, Professional Services"|business_type == "Professional Services, Women's Empowerment Groups virtual & in person"|business_type == "Professional Services, Real Estate"|business_type == "Clean-tech/Green-tech, Professional Services, ELECTRICAL AND FIRE ALARM SERVICES"|business_type == "Professional Services, Business Launch & Life Alignment Coaching"|business_type == "Clean-tech/Green-tech, Manufacturing, Professional Services, HVAC ,Mechanical, Building Automation, Clean safe Air"|business_type == "Financial Services, Professional Services"|business_type == "Bio-tech & Life Sciences, Clean-tech/Green-tech, Creative Economy, Education, Financial Services, Food and Beverage, Healthcare, Manufacturing, Professional Services, Restaurant & Catering, Retail, Technology, Tourism"|business_type == "Clean-tech/Green-tech"|business_type == "Education, Financial Services, Professional Services"|business_type == "Education, Professional Services, Self Development, Communication Skills Coaching"|business_type == "Education, Financial Services, Professional Services, COACHING AND MENTORING"|business_type == "Creative Economy, Financial Services, Professional Services"|business_type == "Legal and Investigative Group"|business_type == "Professional Services, NOTARY PUBLIC, counseling multi services"|business_type == "Healthcare, Professional Services, Social Service", 1, 0),
         entertainment_culture = ifelse(business_type ==  "Tourism, Food, Culture, History of Boston's Chinatown"|business_type ==  "Recreational sports and social events"|business_type ==  "Professional Services, Entertainment"|business_type ==  "Tourism" |business_type ==  "Bio-tech & Life Sciences, Clean-tech/Green-tech, Creative Economy, Education, Financial Services, Food and Beverage, Healthcare, Manufacturing, Professional Services, Restaurant & Catering, Retail, Technology, Tourism"|business_type ==  "E-commerce Natural Skin Care Brand" |business_type ==  "Provide event staff"|business_type ==  "Kid entertainment"|business_type ==  "Events"|business_type ==  "Party Rental Company and Event Space", 1, 0),
         beauty_wellness = ifelse(business_type ==  "apperal ,beauty and health supplies"|business_type ==  "Salon"|business_type ==  "Professional Services, Hair and Makeup"|business_type ==  "Pet Care"|business_type ==  "Makeup Artistry"|business_type ==  "Beauty Salon"|business_type ==  "Professional Services, Hair Salon"|business_type ==  "Wellness"|business_type ==  "Health and wellness"|business_type ==  "Healthcare, Holistic Wellness"|business_type ==  "Healthcare, Hair care"|business_type ==   "Education, Professional Services, Retail, hair salon"|business_type ==  "Creative Economy, Professional Services, Beauty Services"|business_type ==  "Esthetician"|business_type ==  "Fashion/Beauty"|business_type ==  "Spa"|business_type == "I formulate plant based skin care" |business_type == "Hair Salon", 1, 0),
         creative_economy = ifelse(business_type ==  "Creative Economy"|business_type == "Creative Economy, Food and Beverage, Restaurant & Catering"|business_type == "Creative Economy, Food and Beverage, Restaurant & Catering"|business_type == "Creative Economy, Professional Services, Advertising, Marketing, Branding"|business_type == "Creative Economy, Professional Services, Retail, Creative Agency" |business_type ==  "Retail, Interior Design & Construction Project Management"|business_type == "Bio-tech & Life Sciences, Creative Economy, Healthcare"|business_type == "Art"|business_type == "Creative Agency" |business_type == "Creative Economy, Professional Services"|business_type == "Broadcast Media"|business_type == "Creative Economy, Education, Retail"|business_type == "Creative Economy, Contemplative + Healing Arts"|business_type == "Creative Economy, Retail"|business_type == "Interior Design Services"|business_type ==  "Food and Beverage, Retail, Florist"|business_type == "Creative Economy, Professional Services, Beauty Services"|business_type == "Creative Economy, Graphic Design" |business_type == "Creative Economy, Manufacturing"|business_type == "Creative Economy, Professional Services, Photography"|business_type == "Creative Economy, Education, Professional Services"|business_type == "Creative Economy, Market Research, Strategy and Design"|business_type ==  "Creative Economy, Professional Services, Retail", 1, 0),
         retail = ifelse(business_type ==  "apperal ,beauty and health supplies"|business_type == "Retail, Handmade"|business_type == "Retail" |business_type == "Food and Beverage, Retail"|business_type == "Restaurant & Catering, Retail"|business_type == "Creative Economy, Professional Services, Retail, Creative Agency"|business_type == "Retail, Interior Design & Construction Project Management"|business_type == "Creative Economy, Education, Retail"|business_type ==  "Education, Retail" |business_type == "Creative Economy, Retail" |business_type == "Bio-tech & Life Sciences, Clean-tech/Green-tech, Creative Economy, Education, Financial Services, Food and Beverage, Healthcare, Manufacturing, Professional Services, Restaurant & Catering, Retail, Technology, Tourism"|business_type == "Education, Professional Services, Retail, hair salon"|business_type == "Education, Food and Beverage"|business_type == "Creative Economy, Professional Services, Retail", 1, 0),
         services = ifelse(business_type ==  "Cleaning"|business_type == "Clean-tech/Green-tech, Cleaning Company"|business_type == "Building Services-Cleaning"|business_type == "Towing"|business_type ==  "Green Cleaning (Residential"|business_type == "Clean-tech/Green-tech, Education, Healthcare, Personal maid" |business_type == "Clean-tech/Green-tech, Education, Healthcare, Professional Services, Cleaning industry"|business_type == "Janitorial"|business_type == "Pet Care"|business_type ==  "Clothing alteration and dry cleaning"|business_type == "Construction Painting"|business_type == "Provide event staff", 1, 0),
         food = ifelse(business_type ==  "Food and Beverage"|business_type == "Restaurant & Catering, Retail"|business_type == "Restaurant & Catering"|business_type == "Food and Beverage, Restaurant & Catering"|business_type == "Food and Beverage, Retail"|business_type == "Creative Economy, Food and Beverage, Restaurant & Catering"|business_type == "Tourism, Food, Culture, History of Boston's Chinatown"|business_type == "Creative Economy, Food and Beverage, Restaurant & Catering"|business_type == "Extra Virgin Olive Oil"|business_type == "Bio-tech & Life Sciences, Clean-tech/Green-tech, Creative Economy, Education, Financial Services, Food and Beverage, Healthcare, Manufacturing, Professional Services, Restaurant & Catering, Retail, Technology, Tourism"|business_type == "CPG Food Company - Frozen Meal Bites for Kids"|business_type == "Food and Beverage, Retail, Florist"|business_type == "Dog Bakery", 1, 0),
         healthcare = ifelse(business_type ==  "Healthcare"|business_type == "Health & Wellness"|business_type == "Medical spa/ Day Spa"|business_type == "Forensic Science"|business_type == "Education, Healthcare, Retail, Fitness/Wellness"|business_type == "Education, Healthcare, Professional Services, Heath & Wellness"|business_type == "Suicide Prevention - Military and for Spanish speakers" |business_type == "Education, Healthcare, Professional Services"|business_type == "Financial Services, Healthcare, Professional Services"|business_type == "Financial Services, Healthcare, Professional Services, Consulting"|business_type ==  "Bio-tech & Life Sciences, Creative Economy, Healthcare"|business_type == "Clean-tech/Green-tech, Education, Healthcare, Personal maid"|business_type == "Clean-tech/Green-tech, Education, Healthcare, Professional Services, Cleaning industry" |business_type == "Bio-tech & Life Sciences, Clean-tech/Green-tech, Creative Economy, Education, Financial Services, Food and Beverage, Healthcare, Manufacturing, Professional Services, Restaurant & Catering, Retail, Technology, Tourism"|business_type == "Health and wellness"|business_type == "Healthcare, Holistic Wellness" |business_type ==  "Health and Fitness" |business_type ==  "Healthcare, Professional Services, Social Service", 1, 0),
         education = ifelse(business_type ==  "Education, Professional Services, Technology, Data science / predictive modeling"|business_type ==  "Education, Professional Services"|business_type ==  "Education, Nonprofit"|business_type ==  "Education"|business_type ==  "Education, Professional Services, Non Profit"|business_type ==  "Education, Swim School"|business_type ==  "Education, Healthcare, Professional Services, Heath & Wellness"|business_type ==  "Education, Healthcare, Retail, Fitness/Wellness"|business_type ==  "Education, Healthcare, Professional Services" |business_type ==  "Education, Financial Services" |business_type ==  "Clean-tech/Green-tech, Education, Healthcare, Personal maid"|business_type ==  "Clean-tech/Green-tech, Education, Healthcare, Professional Services, Cleaning industry"|business_type ==  "Creative Economy, Education, Retail"|business_type ==  "Education, Retail"|business_type ==  "Bio-tech & Life Sciences, Clean-tech/Green-tech, Creative Economy, Education, Financial Services, Food and Beverage, Healthcare, Manufacturing, Professional Services, Restaurant & Catering, Retail, Technology, Tourism"|business_type ==  "Education, Financial Services, Professional Services"|business_type ==  "Education, Professional Services, Self Development, Communication Skills Coaching" |business_type ==  "Education, Financial Services, Professional Services, COACHING AND MENTORING"|business_type ==  "Education, Professional Services, Retail, hair salon"|business_type ==  "Creative Economy, Education, Professional Services"|business_type ==  "Education, Food and Beverage", 1, 0))
```


# Categorize minority or women owned for modeling
```{r}
women_income <- women_income %>%
  mutate(minority = ifelse(grepl("Minority-owned", other_information), 1, 0),
         just_women = ifelse(minority == 1, 0, 1))

# recategorize minority, veteran-owned to just minority owned (variable of interest)
women_income$other_information[women_income$other_information == "Minority-owned, Veteran-owned"] <- "Minority-owned"

```

```{r}
# Join latitude and longitude columns go dataframe
women_income <- left_join(women_income, women_geocoded[c("cxy_lat", "cxy_lon", "business_name")]) %>%
  select(!c(latitude, longitude)) %>%
  rename(latitude = cxy_lat,
         longitude = cxy_lon)
```


# Calculate distance from center of Boston and angle
```{r}
women_income <- women_income %>%
  rowwise() %>%
  mutate(distance = distGeo(p1 = c(longitude, latitude), 
                            p2 = c(-71.05908,42.36044)),
         angle = bearing(p1 = c(longitude, latitude), 
                            p2 = c(-71.05908,42.36044)))
```


# Descriptive statistics

```{r business types counts}
# Identify the most common recategorized business types
top_category_types <- women_income %>%
  st_drop_geometry() %>%
  count(professional_services, education, food, services, retail, creative_economy, entertainment_culture, beauty_wellness, healthcare) %>%
  pivot_longer(cols = "professional_services":"healthcare") %>%
  # filter for only where the business is of the category
  filter(value == 1) %>%
  group_by(name) %>%
  summarize(n = sum(n))

# Visualize the results
ggplot(top_category_types, aes(x = reorder(name, -n), y = n)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Number of Recategorized Business Types",
       x = "Business Type",
       y = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.title = element_text(""))
```

```{r business types by minority status}
# Identify the most common recategorized business types
top_category_types_minority <- women_income %>%
  st_drop_geometry() %>%
  count(professional_services, education, food, services, retail, creative_economy, entertainment_culture, beauty_wellness, healthcare, minority) %>%
  pivot_longer(cols = "professional_services":"healthcare") %>%
  # filter for only where the business is of the category
  filter(value == 1) %>%
  group_by(name, minority) %>%
  summarize(n = sum(n)) %>%
  mutate(`Minority status` = ifelse(minority == 1, "Minority and women owned", "Women owned"))

# Visualize the results
ggplot(top_category_types_minority, aes(x = reorder(name, -n), y = n, fill = `Minority status`)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Number of Recategorized Business Types by Minority Status",
       x = "Business Type",
       y = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.title = element_text(""))
```

```{r median income and business type}
# Descriptive statistics by category
category_stats <- women_income %>%
  st_drop_geometry() %>%
  select(professional_services, education, food, services, retail, creative_economy, entertainment_culture, beauty_wellness, healthcare, estimate_families_median_income_dollars) %>%
  pivot_longer(cols = "professional_services":"healthcare") %>%
  # filter for only where the business is of the category
  filter(value == 1) %>%
  group_by(name) %>%
  summarize(median_income =  median(estimate_families_median_income_dollars, na.rm = T))

# Visualize median income by category
ggplot(category_stats, aes(x = reorder(name, -median_income), y = median_income)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  theme_minimal() +
  coord_flip() +
  labs(title = "Median Income by Business Category", x = "Category", y = "Median Income")
```

```{r median income bvy minority status}
# Group data by minority/immigrant status and calculate median income
median_income_by_minority <- women_income %>%
  group_by(minority) %>%
  summarise(median_income = median(estimate_families_median_income_dollars, na.rm = TRUE)) %>%
  mutate(`Minority status` = ifelse(minority == 1, "Minority and women owned", "Women owned"))

# Visualize the results
ggplot(median_income_by_minority, aes(x = as.factor(`Minority status`), y = median_income)) +
  geom_bar(stat = "identity", fill = "mediumpurple") +
  labs(title = "Median Income by Minority Status",
       x = "Minority Status",
       y = "Median Income") +
  theme_minimal()

```


```{r median income by minority status and business type}

# Descriptive statistics by minority status and category
minority_category_stats <- women_income %>%
  st_drop_geometry() %>%
  select(professional_services, education, food, services, retail, creative_economy, entertainment_culture, beauty_wellness, healthcare, estimate_families_median_income_dollars, minority) %>%
  pivot_longer(cols = "professional_services":"healthcare") %>%
  # filter for only where the business is of the category
  filter(value == 1) %>%
  group_by(minority, name) %>%
  summarise(count = n(),
            median_income = median(estimate_families_median_income_dollars, na.rm = TRUE)) %>%
  mutate(`Minority status` = ifelse(minority == 1, "Minority and women owned", "Women owned"))

# Visualize median income by minority status and category
ggplot(minority_category_stats, aes(x = reorder(name, -median_income), y = median_income, fill = `Minority status`)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  coord_flip() +
  labs(title = "Median Income by Minority Status and Business Category", x = "Category", y = "Median Income")

```

```{r}
library(corrplot)

women_income_corrplot <- women_income %>%
  rename(`Median income ($)` = estimate_families_median_income_dollars,
         Distance = distance,
         Angle = angle)

# Correlation matrix for selected variables
correlation_matrix <- cor(women_income_corrplot[,c("Median income ($)", "Distance", "Angle")] %>%
  st_drop_geometry(), use = "complete.obs")
  

# Visualize the correlation matrix
corrplot(correlation_matrix, method = "color", type = "upper", tl.col = "black", tl.srt = 45, addCoef.col = "white")

```

```{r distance and business type, by minority status}
# Descriptive statistics by minority status and category

distance_category_stats <- women_income %>%
  st_drop_geometry() %>%
  select(professional_services, education, food, services, retail, creative_economy, entertainment_culture, beauty_wellness, healthcare, distance, minority) %>%
  pivot_longer(cols = "professional_services":"healthcare") %>%
  # filter for only where the business is of the category
  filter(value == 1) %>%
  group_by(minority, name) %>%
  summarise(count = n(),
            median_distance = median(distance, na.rm = TRUE)) %>%
  mutate(`Minority status` = ifelse(minority == 1, "Minority and women owned", "Women owned"))

# Visualize median income by minority status and category
ggplot(distance_category_stats, aes(x = reorder(name, -median_distance), y = median_distance, fill = `Minority status`)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  coord_flip() +
  labs(title = "Median Distance from Downtown Boston by Minority Status \n and Business Category", x = "Category", y = "Distance (m)")

```




## Map of income and location of businesses
```{r}
# create dataframe on tracts which contain women owned businesses in the dataset
income_women_tract <- st_join(income_geo, women_geocoded_sf) %>%
  filter(!is.na(business_name)
         & variable == "S1901_C01_012") %>%
  filter(!duplicated(GEOID))

# plot
map0 <- tm_shape(income_women_tract) +tm_fill(col="estimate", title="Median income and location of women-owned businesses by census tract")+tm_borders() + tmap_mode("view") +
  tm_shape(women_income) + 
  tm_dots("just_women", title = "Additional demographic info", breaks = c(0,.9,1.1), labels = c("Minority owned", "Just women-owned"), palette=c('green','blue'))
map0
```


## PCA of median income, distance, and angle
```{r}
library(psych)

#subset to columns
women_income_subset <- women_income %>%
  st_drop_geometry() %>%
  select(c("estimate_families_median_income_dollars", "distance", "angle"))

# conduct pca
pca <- principal(women_income_subset, rotate="none", nfactors=3, scores=TRUE)

#show the eigenvalues 
pca$values 

#communality closer to 1 means variable is better explained by the components
pca$communality

# look at correlations
pca$loadings
```

```{r}
library(RColorBrewer)

#save the scores for each location
women_income_pca <- cbind(women_income, pca$scores)

#create palette
pc_palette <- brewer.pal(5, "RdYlBu")

#Mapping the first three components 
map_pc1 <- tm_shape(women_income_pca) +tm_dots(col = "PC1", title = "High income, close to Boston", palette = pc_palette)
map_pc1
map_pc2 <- tm_shape(women_income_pca) +tm_dots(col="PC2", title="Angle from downtown Boston", palette = pc_palette)
map_pc2
map_pc3 <- tm_shape(women_income_pca) +tm_dots(col="PC3", title="Mid-level income, mid-level distance", palette = pc_palette)
map_pc3
```


# k Nearest Neighbor model

```{r}
# get info on if minority or not
# filter out census tract with no residents, so no median income
# remove spatial aspect of df to get rid of geometry columns
 women_income_knn <- women_income %>%
  mutate(other_information = ifelse(grepl("Minority", other_information), "Minority-owned", "N/A")) %>%
  filter(!is.na(estimate_families_median_income_dollars)) %>%
  st_drop_geometry()
```

```{r}
# Normalize the predictors individually
women_income_knn$distance_norm <- scale(women_income_knn$distance)
women_income_knn$angle_norm <- scale(women_income_knn$angle)
women_income_knn$median_norm <- scale(women_income_knn$estimate_families_median_income_dollars)
```

```{r}
# Set seed for reproducibility
set.seed(12)

# Select only the normalized columns and "business_outcome" for classification
women_income_subset <- women_income_knn[, c("distance_norm", "angle_norm","median_norm","other_information")]

# Split data into 60% training and 40% temporary from the total number of rows
train_set_indices <- sample(1:nrow(women_income_subset), 0.6 * nrow(women_income_subset), replace = FALSE)
train_data <- women_income_subset[train_set_indices, ]
temp_data <- women_income_subset[-train_set_indices, ]

# Split temp_data by 50% to get 20% validation and test data each
test_set_indices <- sample(1:nrow(temp_data), 0.5 * nrow(temp_data), replace = FALSE)
test_data <- temp_data[test_set_indices, ]
validation_data <- temp_data[-test_set_indices, ]

# Print the subset of data
print(women_income_subset)

# Check dimensions of the train, test, and validation data
dim(women_income_subset)
dim(train_data)
dim(test_data)
dim(validation_data)

```

```{r}
#check for null values in train, test, validation data
any(is.na(train_data))
any(is.na(test_data))
any(is.na(validation_data))
```

```{r}
library(class)

set.seed(12)

# Initialize a vector to store accuracy for each k
accuracy_vector <- numeric(20)

# Loop over k values from 1 to 20
for (k in 1:20) {
  # Use knn to predict species on the validation set
  predicted_income <- knn(train_data[, -4], validation_data[, -4], train_data$other_information, k = k)
  
  # Calculate accuracy for this k
  accuracy <- sum(predicted_income == validation_data$other_information) / length(validation_data$other_information)
  
  # Store the accuracy in the accuracy_vector
  accuracy_vector[k] <- accuracy
  cat("Accuracy for k =", k, ":", accuracy, "\n")
}

# Find the highest accuracy and its corresponding k
best_accuracy <- max(accuracy_vector)
best_k <- which(accuracy_vector == best_accuracy)

cat("The highest accuracy is", best_accuracy, "and it occurs for k =", best_k, "\n")

```

```{r}
# graph accuracy and k value
df <- data.frame(k = 1:20, accuracy = accuracy_vector)

ggplot(df, aes(x = k, y = accuracy)) +
  geom_line() +
  geom_point() +
  labs(title = "Accuracy vs. K Value", x = "K Value", y = "Accuracy") +
  theme_minimal()
```


```{r}
library(caret)

set.seed(12)

#using k=15
predicted_demographic <- knn(train_data[, -4], test_data[, -4], train_data$other_information, k = 15)

print(table(predicted_demographic,test_data$other_information))

print(mean(predicted_demographic==test_data$other_information))
```

# Random forest model
```{r}
# Set seed for reproducibility 
set.seed(12)

# use same cleaned dataframe from knn
women_income_subset_rf <- women_income_knn[,c("distance","angle","estimate_families_median_income_dollars","other_information","professional_services", "entertainment_culture", "beauty_wellness", "creative_economy", "retail", "services", "food", "healthcare", "education")]

# Split data into 60% training and 40% temporary from the total number of rows
train_set_indices_rf <- sample(1:nrow(women_income_subset_rf), 0.6 * nrow(women_income_subset_rf), replace = FALSE)
train_data_rf <- women_income_subset_rf[train_set_indices_rf, ]
temp_data_rf <- women_income_subset_rf[-train_set_indices_rf, ]

# Split temp_data by 50% to get 20% valid and test data each
test_set_indices_rf <- sample(1:nrow(temp_data_rf), 0.5 * nrow(temp_data_rf), replace = FALSE)
test_data_rf <- temp_data_rf[test_set_indices_rf, ]
validation_data_rf <- temp_data_rf[-test_set_indices_rf, ]


train_data_rf$other_information <- as.factor(train_data_rf$other_information)
test_data_rf$other_information <- as.factor(test_data_rf$other_information)


```

```{r}
library(randomForest)

# set seed
set.seed(12)

#Random Forest model
rf <- randomForest(train_data_rf$other_information ~ distance + angle + estimate_families_median_income_dollars + professional_services + entertainment_culture + beauty_wellness + creative_economy + retail + services + food + healthcare + education, 
                    data=train_data_rf, 
                    mtry=12, 
                    importance=TRUE)
rf_pred <- predict(rf, test_data_rf)
accuracy <- sum(rf_pred == test_data_rf$other_information) / nrow(test_data_rf)
print(accuracy)
```

```{r}
# look at most important variables
importance_vars <- importance(rf)
top_vars <- rownames(importance_vars[order(-importance_vars[,1]),])[1:10]
print(top_vars)
```
```{r}
# Assuming rf is a random forest model object from which you can extract feature importance
importance_vars <- importance(rf)
top_vars <- rownames(importance_vars[order(-importance_vars[,1]),])[1:10]
print(top_vars)

# Load necessary libraries
library(forcats)
library(ggplot2)

# You should replace `sample(1:10, 10)` with actual importance scores
data <- data.frame(
  name = top_vars,
  val = importance_vars[order(-importance_vars[,1]),1][1:10]
)

# Reorder and plot the data
ggplot(data, aes(x=fct_reorder(name, val), y=val)) +
  geom_bar(stat="identity", fill="#f68060", alpha=.6, width=.4) +
  coord_flip() +
  labs(title = "Importance of features", x="", y="Importance") +
  theme_bw()

```

# Logistic regression model
```{r}
set.seed(12)
# use women_income_knn dataframe because formatted for model
# fit the model
glm.fits <- glm(minority ~ distance + angle + estimate_families_median_income_dollars + professional_services + entertainment_culture + beauty_wellness + creative_economy + retail + services + food + healthcare + education, 
                data = women_income_knn, 
                family = binomial)
summary(glm.fits)
```
```{r}
# Load necessary libraries
library(ggplot2)

# Get model coefficients and convert to data frame
coefficients <- coef(summary(glm.fits))
coef_df <- as.data.frame(coefficients)

# Reset row names to create a variable column
coef_df$Variable <- rownames(coef_df)
rownames(coef_df) <- NULL

# Plot using ggplot2
ggplot(coef_df, aes(x = Variable, y = Estimate)) +
  geom_bar(stat = "identity", position = "dodge", fill = "skyblue") + 
  theme_minimal() +
  labs(x = "Predictor", y = "Coefficient Estimate", title = "Logistic Regression Coefficients") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) # Rotate x-axis labels by 45 degrees

```

```{r}
# prdictions and accuracy
predictions <- predict(glm.fits, type = "response")

predicted_class <- ifelse(predictions > 0.5, 1, 0)


confusion_matrix <- table(predicted_class, women_income_knn$minority)
print(confusion_matrix)

accuracy <- sum(predicted_class == women_income_knn$minority) / nrow(women_income_knn)
print(accuracy)
```

```{r}
set.seed(12)

glm.start <- glm(minority ~ 1, data = women_income_knn, family = binomial)

#forward selection, using AIC
glm.forward <- step(glm.start, scope = list(lower = glm.start, upper = glm.fits), 
                    direction = "forward")

summary(glm.forward)
```

```{r}

# Get model coefficients and convert to data frame
coefficients <- coef(summary(glm.forward))
coef_df <- as.data.frame(coefficients)

# Reset row names to create a variable column
coef_df$Variable <- rownames(coef_df)
rownames(coef_df) <- NULL

# Plot using ggplot2
ggplot(coef_df, aes(x = Variable, y = Estimate)) +
  geom_bar(stat = "identity", position = "dodge", fill = "skyblue") + 
  theme_minimal() +
  labs(x = "Predictor", y = "Coefficient Estimate", title = "Logistic Regression Coefficients") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) # Rotate x-axis labels by 45 degrees

```


```{r}
# prdictions and accuracy
predictions <- predict(glm.forward, type = "response")

predicted_class <- ifelse(predictions > 0.5, 1, 0)


confusion_matrix <- table(predicted_class, women_income_knn$minority)
print(confusion_matrix)

accuracy <- sum(predicted_class == women_income_knn$minority) / nrow(women_income_knn)
print(accuracy)
```

